<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>15分钟健身圈</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Microsoft YaHei', sans-serif;
      }
      body {
        background-color: #f0f2f5;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      header {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        padding: 20px;
        text-align: center;
      }
      h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }
      .subtitle {
        font-size: 16px;
        opacity: 0.9;
      }
      .panel {
        padding: 20px;
        background: #f9f9f9;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        border-bottom: 1px solid #eaeaea;
      }
      .panel input, .panel select {
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        flex: 1;
        min-width: 200px;
      }
      .panel button {
        padding: 12px 25px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s;
      }
      .panel button:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      #map-container {
        height: 600px;
        width: 100%;
      }
      .info-window {
        padding: 15px;
        min-width: 250px;
      }
      .info-window h3 {
        margin-top: 0;
        color: #2e7d32;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      .info-window p {
        margin: 8px 0;
        color: #555;
      }
      .info-window .distance {
        color: #e91e63;
        font-weight: bold;
      }
      .legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
      }
      .legend h3 {
        margin-bottom: 10px;
        color: #333;
        font-size: 16px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 50%;
      }
      .status-bar {
        padding: 12px 20px;
        background: #e8f5e9;
        color: #2e7d32;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      footer {
        text-align: center;
        padding: 15px;
        color: #666;
        font-size: 14px;
        background: #f9f9f9;
        border-top: 1px solid #eaeaea;
      }
      @media (max-width: 768px) {
        .panel {
          flex-direction: column;
          align-items: stretch;
        }
        .panel input, .panel select {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>15分钟健身圈</h1>
        <p class="subtitle">探索您15分钟步行范围内的健身场所</p>
      </header>
      
      <div class="panel">
        <button onclick="getLocation()">获取我的位置</button>
        <select id="citySelect">
          <option value="石家庄市" selected>石家庄</option>
          <option value="保定市">保定</option>
          <option value="唐山市">唐山</option>
          <option value="秦皇岛市">秦皇岛</option>
          <option value="承德市">承德</option>
          <option value="张家口市">张家口</option>
          <option value="沧州市">沧州</option>
          <option value="衡水市">衡水</option>
          <option value="邢台市">邢台</option>
          <option value="邯郸市">邯郸</option>
        </select>
        <input type="text" id="searchInput" placeholder="输入地址进行搜索" />
        <button onclick="searchLocation()">搜索</button>
      </div>
      
      <div class="status-bar">
        <span id="statusInfo">就绪</span>
        <span id="locationInfo"></span>
      </div>
      
      <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>正在搜索健身场所，请稍候...</p>
      </div>
      
      <div id="map-container"></div>
      
      <div class="legend">
        <h3>图例</h3>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #87ceeb"></div>
          <span>15分钟步行范围</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ff6b6b"></div>
          <span>健身场所</span>
        </div>
      </div>

    </div>

    <script
      type="text/javascript"
      src="https://api.map.baidu.com/api?v=3.0&ak=Rax1ngofYjLj0QR6EDhHTnlZididPUVK"
    ></script>
    <script>
      let map = null
      let circle = null
      let markers = []
      let currentCenter = null
      const WALK_SPEED = 5 // 步行速度5km/h

      // 初始化地图
      function initMap(lng, lat) {
        map = new BMap.Map('map-container')
        const point = new BMap.Point(lng, lat)
        map.centerAndZoom(point, 15)
        map.enableScrollWheelZoom(true)

        // 添加比例尺控件
        map.addControl(new BMap.ScaleControl())
        // 添加缩放控件
        map.addControl(new BMap.NavigationControl())
        
        // 添加地图类型控件
        map.addControl(new BMap.MapTypeControl())

        return point
      }

      // 更新状态信息
      function updateStatus(message, isError = false) {
        const statusElement = document.getElementById('statusInfo')
        statusElement.textContent = message
        statusElement.style.color = isError ? '#e53935' : '#2e7d32'
      }
      
      // 更新位置信息
      function updateLocationInfo(lng, lat) {
        document.getElementById('locationInfo').textContent = 
          `经度: ${lng.toFixed(4)}, 纬度: ${lat.toFixed(4)}`
      }

      // 显示加载指示器
      function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block'
      }
      
      // 隐藏加载指示器
      function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none'
      }

      // 计算可达半径（米）
      function calculateRadius() {
        const minutes = 15
        const hours = minutes / 60
        return WALK_SPEED * hours * 1000 // 转换为米
      }

      // 绘制圆形范围
      function drawCircle(center, radius) {
        if (circle) map.removeOverlay(circle)
        circle = new BMap.Circle(center, radius, {
          strokeColor: '#1976d2',
          strokeWeight: 3,
          strokeOpacity: 0.8,
          strokeStyle: 'solid',
          fillColor: '#87ceeb',
          fillOpacity: 0.4
        })
        map.addOverlay(circle)
        
        // 保存当前中心点
        currentCenter = center
        
        // 设置地图中心点和视图
        map.centerAndZoom(center, 15)
        
        // 计算合适的缩放级别，确保圈完全可见
        const viewport = map.getViewport([center]);
        const zoom = viewport.zoom;
        map.setZoom(zoom - 1);
        
        updateLocationInfo(center.lng, center.lat)
      }

      // 清除所有标记
      function clearMarkers() {
        markers.forEach((marker) => map.removeOverlay(marker))
        markers = []
      }

      // 搜索体育场所
      function searchGym(center, radius) {
        clearMarkers() // 清除之前的标记
        showLoading()
        updateStatus('正在搜索健身场所...')

        const local = new BMap.LocalSearch(map, {
          renderOptions: { 
            map: map
          },
          onSearchComplete: function (results) {
            hideLoading()
            if (local.getStatus() === BMAP_STATUS_SUCCESS) {
              let foundCount = 0
              for (let i = 0; i < results.getCurrentNumPois(); i++) {
                const item = results.getPoi(i)
                
                // 只显示在圆圈范围内的地点
                const distance = map.getDistance(center, item.point)
                if (distance <= radius) {

                  foundCount++
                }
              }

              if (foundCount === 0) {
                updateStatus('在15分钟步行范围内未找到健身场所', true)
              } else {
                updateStatus(`找到 ${foundCount} 个健身场所`)
              }
              
              // 确保地图视图以圆圈为中心
              map.centerAndZoom(currentCenter, map.getZoom());
            } else {
              updateStatus('搜索失败，请稍后重试', true)
            }
          }
        })

        local.searchNearby(
          '健身房,体育馆,健身中心,游泳馆,运动场,篮球场,足球场,羽毛球场,健身馆,公园,体育中心',
          center,
          radius
        )
      }

      // 浏览器定位
      function getLocation() {
        if (!navigator.geolocation) {
          updateStatus('您的浏览器不支持地理定位', true)
          return
        }

        updateStatus('正在获取您的位置...')
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const point = new BMap.Point(
              pos.coords.longitude,
              pos.coords.latitude
            )
            initMap(point.lng, point.lat)
            const radius = calculateRadius()
            drawCircle(point, radius)
            updateStatus('已定位到您的位置')
            searchGym(point, radius)
          },
          (error) => {
            updateStatus('定位失败: ' + error.message, true)
            // 默认使用石家庄中心点
            const point = initMap(114.404, 38.915)
            const radius = calculateRadius()
            drawCircle(point, radius)
            searchGym(point, radius)
          }
        )
      }

      // 地址搜索 - 改进版本
      function searchLocation() {
        const query = document.getElementById('searchInput').value.trim()
        const city = document.getElementById('citySelect').value

        if (!query) {
          updateStatus('请输入搜索地址', true)
          return
        }

        updateStatus(`正在搜索 "${query}"...`)
        showLoading()

        // 使用百度地图地点搜索API，更精确
        const localSearch = new BMap.LocalSearch(city, {
          onSearchComplete: function(results) {
            if (localSearch.getStatus() === BMAP_STATUS_SUCCESS && results.getCurrentNumPois() > 0) {
              // 获取第一个结果
              const firstResult = results.getPoi(0)
              
              // 验证结果是否在所选城市
              if (firstResult.city === city.replace('市', '') || city.includes(firstResult.city)) {
                initMap(firstResult.point.lng, firstResult.point.lat)
                const radius = calculateRadius()
                drawCircle(firstResult.point, radius)
                updateStatus(`已定位到: ${firstResult.title}`)
                searchGym(firstResult.point, radius)
              } else {
                hideLoading()
                updateStatus(`未在${city}找到"${query}"，请尝试更精确的地址`, true)
              }
            } else {
              hideLoading()
              updateStatus(`未找到"${query}"，请尝试更精确的地址`, true)
            }
          }
        })
        
        localSearch.search(query)
      }

      // 页面加载完成后默认显示石家庄
      window.onload = function () {
        const point = initMap(114.404, 38.915) // 石家庄市中心坐标
        const radius = calculateRadius()
        drawCircle(point, radius)
        updateStatus('已就绪，请输入地址或使用定位功能')
      }
    </script>
  </body>
</html>